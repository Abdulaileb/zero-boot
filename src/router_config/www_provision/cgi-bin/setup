#!/bin/sh

##adding dry run mode for testing without applying changes
DRY_RUN=false


# --- LOGGING & HELPERS ---
log_msg() {
    logger -t "zero_trust_setup" "$1"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> /tmp/zero_trust_setup.log
}

urldecode() {
    local str="$1"
    str="$(echo "$str" | sed 's/+/ /g')"
    str="$(echo "$str" | sed 's/%\([0-9A-Fa-f][0-9A-Fa-f]\)/\\x\1/g')"
    printf '%b' "$str"
}

echo "Content-type: text/html; charset=utf-8"
echo ""

# --- 1. PARSE INPUT ---
if [ -f "/etc/config/zero_trust_complete" ]; then
    echo "<html><body><h1>Error: Already Configured</h1></body></html>"
    exit 1
fi

if [ -n "$CONTENT_LENGTH" ]; then
    POST_DATA=$(dd bs=1 count=$CONTENT_LENGTH 2>/dev/null)
else
    POST_DATA=$(cat)
fi

RAW_USER=$(echo "$POST_DATA" | sed -n 's/^.*username=\([^&]*\).*$/\1/p')
RAW_PASS=$(echo "$POST_DATA" | sed -n 's/^.*password=\([^&]*\).*$/\1/p')
USER=$(urldecode "$RAW_USER")
PASS=$(urldecode "$RAW_PASS")

if [ -z "$USER" ] || [ -z "$PASS" ]; then
    echo "<html><body><h1>Error: Missing Fields</h1></body></html>"
    exit 1
fi

# --- 2. HASHING ---
log_msg "Hashing password..."
HASH=$(python3 << 'PYEOF'
from passlib.hash import argon2
import sys
try:
    password = """$PASS"""
    hash_result = argon2.using(
        type='id',
        time_cost=2,
        memory_cost=16384,
        parallelism=2,
        salt_size=16
    ).hash(password)
    print(hash_result)
except Exception:
    sys.exit(1)
PYEOF
)

if [ -z "$HASH" ]; then
    echo "<html><body><h1>Error: Hashing Failed</h1></body></html>"
    exit 1
fi

# --- 3. SAVE CONFIG ---
echo "$USER:$HASH" > /etc/config/zero_trust_credentials
chmod 600 /etc/config/zero_trust_credentials
echo -e "$PASS\n$PASS" | passwd root >/dev/null 2>&1

### For management 

##Hardware switch transaltion (DSA - Distributed Switch Architecture)
## I remove lan4 from the br-lan and assign it to eth0.99 (VLAN 99)
if [ -d "/sys/class/net/lan4" ]; then
    # DSA switch detected
    log_msg "Configuring DSA switch for management VLAN..."

    # Remove lan4 from br-lan
    #[ "$DRY_RUN" = "true" ] && echo "uci del_list network.lan.ports='lan4'" ||
    uci del_list network.@device[0].ports='lan4'

    uci set network.device_mgmt=device
    uci set network.device_mgmt.name='br-mgmt'
    uci set network.device_mgmt.type='bridge'
    uci add_list network.device_mgmt.ports='lan4'
    uci set network.mgmt.device='br-mgmt'
else
    log_msg "No DSA switch detected, skipping switch config."

    uci set.network.mgmt.device='eth0.99'
fi


# Then wrap your uci commands like this:
#[ "$DRY_RUN" = "true" ] && echo "uci set network.mgmt.device='br-mgmt'" || uci set network.mgmt.device='br-mgmt'

## Create a new bridge for management VLAN


# Management interface on VLAN 99 (eth1.99)
uci set network.mgmt=interface
uci set network.mgmt.proto='static'
# uci set network.mgmt.device='br-mgmt'
uci set network.mgmt.ipaddr='192.168.99.1'
uci set network.mgmt.netmask='255.255.255.0'

#firewall and the webserver access
uci add_list firewall.@zone[0].network='mgmt'
uci delete uhttpd.main.listen_http 2>/dev/null
uci add_list uhttpd.main.listen_http='192.168.99.1:80'
uci set uhttpd.main.home='/www'

# Mark as complete and commit changes
touch /etc/config/zero_trust_complete
chmod 444 /etc/config/zero_trust_complete
uci commit

log_msg "Configuration saved. Sending HTML..."

# --- 4. SEND SUCCESS PAGE ---
cat << EOF

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Setup Complete</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
    background: linear-gradient(135deg, #6366f1 0%, #7c3aed 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .card {
    background: #ffffff;
    border-radius: 16px;
    padding: 30px 34px 24px;
    max-width: 640px;
    width: 100%;
    box-shadow: 0 20px 60px rgba(15, 23, 42, 0.35);
  }
  h1 {
    color: #16a34a;
    text-align: center;
    margin-bottom: 6px;
    font-size: 22px;
  }
  .subtitle {
    text-align: center;
    font-size: 14px;
    color: #4b5563;
    margin-bottom: 16px;
  }
  .step {
    background: #f9fafb;
    padding: 12px 14px;
    margin-top: 10px;
    border-radius: 8px;
    border-left: 4px solid #6366f1;
    font-size: 13px;
    color: #111827;
  }
  .step strong {
    display: block;
    margin-bottom: 4px;
  }
  .note {
    margin-top: 14px;
    font-size: 12px;
    color: #6b7280;
    text-align: center;
    line-height: 1.4;
  }
  .timer {
    margin-top: 6px;
    font-size: 12px;
    color: #374151;
    text-align: center;
  }
  .button {
    display: block;
    margin: 16px auto 0;
    padding: 10px 20px;
    max-width: 260px;
    text-align: center;
    background: #6366f1;
    color: #ffffff;
    text-decoration: none;
    border-radius: 999px;
    font-size: 14px;
    font-weight: 500;
  }
  .button:hover {
    background: #4f46e5;
  }
</style>
</head>
<body>
  <div class="card">
    <h1>✓ Setup complete</h1>
    <p class="subtitle">
      User <strong>$USER</strong> was created successfully and the zero‑trust boot profile is now active.
    </p>

    <div class="step">
      <strong>Step 1 · Network configuration changed</strong>
      Management access has moved to <strong>VLAN 99</strong> (192.168.99.0/24) on the dedicated management interface.
    </div>

    <div class="step">
      <strong>Step 2 · Access the management console</strong>
      Configure your management device with:
      <br>IP address: <strong>192.168.99.5</strong>
      <br>Gateway: <strong>192.168.99.1</strong>
      <br>Then open: <strong>http://192.168.99.1</strong>
    </div>

    <p class="note">
      Your current connection to <strong>192.168.2.1</strong> will stop working as the router switches
      to the management VLAN. This is expected; reconnect using the settings above.
    </p>

    <p class="timer">
      Redirecting to <strong>http://192.168.99.1</strong> in
      <span id="countdown">10</span> seconds…
    </p>

    <a href="http://192.168.99.1" class="button" id="continueBtn">
      Go to management console now
    </a>
  </div>

<script>
  (function () {
    var remaining = 10;
    var span = document.getElementById('countdown');
    var target = 'http://192.168.99.1';

    function tick () {
      remaining--;
      if (span) span.textContent = remaining;
      if (remaining <= 0) {
        window.location.href = target;
        return;
      }
      setTimeout(tick, 1000);
    }

    if (span) span.textContent = remaining;
    setTimeout(tick, 1000);
  })();
</script>

</body>
</html>
EOF

# --- 5. APPLY CHANGES IN BACKGROUND ---
(
    sleep 1
    #/etc/init.d/network reload
    #/etc/init.d/firewall reload
    ifup mgmt
    /etc/init.d/uhttpd restart
) &

#> /dev/null 2>&1 &
exit 0
